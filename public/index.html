<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Widget with Event Triggers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #display { border: 1px solid #ccc; padding: 10px; min-height: 60px; margin-top: 10px; }
    #sendButton { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>External Widget</h2>
  <button id="requestContext">Get Agent Context</button>
  <div id="display">Waiting for user context...</div>

  <script>
    // Trigger getUserContext event to liveInteraction
    

    function getConversationContext() {
    let message = {
    action: 'getUserContext'
    };
    window.parent.postMessage(message, '*')
    }

    function copyText() {
    let message = {
    action: 'copyText',
    text: 'text from widget direct to smartassist' //can be modified accordingly
    };
    window.parent.postMessage(message, '*')
    }


    
      console.log("📥 Message received from parent:", event.data);
      var lastUserMessage = getLastUserMessage(event.data.messages)
      console.log("last user message", lastUserMessage)
      const res = await fetch("/api/agent-message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lastUserMessage })
        });

        const data = await res.json();
        console.log("✅ Response from backend:", data);

        // Send processed response to agent compose bar
        console.log("📤 Sending copyText to parent:", data.response);
        window.parent.postMessage({ type: "copyText", message: data.response }, "*");


    document.getElementById("requestContext").addEventListener("click", () => {
      console.log("🖱️ Get Agent Context button clicked");
      copyText();
    });

    // Optional trigger on load
    window.onload = () => {
      console.log("🌐 Window loaded, requesting user context...");
      getConversationContext();
    };
  </script>
</body>
</html>
